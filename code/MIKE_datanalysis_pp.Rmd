---
title: "Mike Analysis"
author: "Lindesay Scott-Hayward"
date: "August 2020"
output: pdf_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,warning=FALSE, message=FALSE, dev="png")
```

```{r, warning=FALSE, message=FALSE}
#devtools::install_git("https://github.com/lindesaysh/MRSea.git")
devtools::load_all('C:/Users/lass/Documents/GitHub/MRSea')
#require(MRSea)
require(splancs)
require(ggplot2)
require(fields)
require(splines)
require(spatstat)
library(sp)
library(rgdal)
require(dplyr)
computer='pc'
```

```{r, results="hide"}
fences<-readOGR(dsn='../data/shapefiles', layer="enp fence line", verbose = FALSE)
proj4string(fences) <- CRS("+proj=longlat +datum=WGS84")  ## for example
fences <- spTransform(fences, CRS("+proj=utm +zone=33 ellps=WGS84"))
fences_fortify<-fortify(fences)
```

```{r, results='hide'}
pans<-readOGR(dsn='../data/shapefiles', layer="enp pans", verbose=FALSE)
proj4string(pans) <- CRS("+proj=longlat +datum=WGS84")  ## for example
pans <- spTransform(pans, CRS("+proj=utm +zone=33 ellps=WGS84"))
```

```{r}
# load in pan data (2.5km internal buffer)
largepan<-read.csv('../data/largepan.csv')
largepan<-largepan/1000
largepan.list<-list(x=largepan$x, y=largepan$y)
```

```{r}
# ENP boundary plus 20km
fence<-read.csv('../data/databoundary.csv')
fence<-fence[nrow(fence):1,]/1000
fence.list<-list(x=fence$x.pos, y=fence$y.pos)
```

```{r}
# read in points data
datcomb<- read.csv("../data/datcomb.csv", header=TRUE)
```

```{r}
#subset just to get the presences
dat.pres<-datcomb[datcomb$response==1,]
dat<-datcomb[datcomb$response==1,c('x.pos', 'y.pos')]/1000
```

```{r}
ggplot(dat.pres) + geom_point(aes(x.pos, y.pos), alpha=1/2) + facet_wrap(~year)
ggplot(dat.pres) + geom_point(aes(x.pos, y.pos), alpha=1/2) + facet_wrap(~month)
```

```{r}
# create boundary listing so that quad points created in correct area
Z<-owin(poly=list(fence.list, largepan.list))

x<-dat$x.pos
y<-dat$y.pos

P<-ppp(x, y, poly=list(fence.list, largepan.list))
plot(P)
```

```{r}
dummyQpts<-quadscheme(P, eps=2)$dummy
dpts<-data.frame(x.pos=dummyQpts$x, y.pos=dummyQpts$y)
plot(dummyQpts)
plot(P, add = TRUE, cex = 0.5)
```

```{r}
analysisdat<-rbind(data.frame(dat, response=1), data.frame(dpts, response=0))
kga<- data.frame(x.pos=dat$x.pos, y.pos=dat$y.pos)
set.seed(1234)
kgb<- getKnotgrid(coordData = dpts, numKnots = 50, plot = FALSE)
kg<-rbind(kga, kgb)
duplicatedid<-which(duplicated(kga)==TRUE)
if(length(duplicatedid)>0){ kg<-kg[-duplicatedid,]}
```

```{r}
distMats<-makeDists(cbind(analysisdat$x.pos, analysisdat$y.pos), kg)

```


```{r}
p.wt<-rep(1e-6, nrow(analysisdat))
p.wt[analysisdat$response==0]<-summary(dummyQpts)$window$area/sum(analysisdat$response==0)
# must have column in data called pp.wts
analysisdat$pp.wts<-p.wt
```


# Data prep

```{r}

path2020<-"C:\\Users\\lass\\OneDrive - University of St Andrews\\papers\\papers\\CarcassSALSApaper\\August2020\\data\\shapefiles"
if(computer=='pc'){path1=path2020; path2 = path2020; path3=path2020}
```


```{r}
roads<-readOGR(dsn=path1, layer='enp roads', verbose = FALSE)
proj4string(roads) <- CRS("+proj=longlat +datum=WGS84")  ## for example
roadsUTM <- spTransform(roads, CRS("+proj=utm +zone=33 ellps=WGS84"))
roads_fortify<-fortify(roadsUTM)

water<-readOGR( dsn=path1,  layer="waters2", verbose = FALSE)
proj4string(water) <- CRS("+proj=longlat +datum=WGS84")  ## for example
waterUTM <- spTransform(water, CRS("+proj=utm +zone=33 ellps=WGS84"))

waterh<-readOGR( dsn=path2,  layer="functional water", verbose = FALSE)
proj4string(waterh) <- CRS("+proj=longlat +datum=WGS84")  ## for example
waterholes <- spTransform(waterh, CRS("+proj=utm +zone=33 ellps=WGS84"))
waterholelocs<-data.frame(waterholes@coords)

tracks<-readOGR( dsn=path3, layer="TRACK", verbose = FALSE)
#tracks_fortify<-fortify(tracks)
proj4string(tracks) <- CRS("+proj=longlat +datum=WGS84")  ## for example
tracksUTM <- spTransform(tracks, CRS("+proj=utm +zone=33 ellps=WGS84"))
tracks_fortify<-fortify(tracksUTM)
```

Calculate the distance to the nearest water hole:

```{r}
waterholedists<-makeDists(cbind(analysisdat$x.pos, analysisdat$y.pos), knotcoords = waterholes@coords/1000,knotmat = FALSE)

analysisdat$distwater_km<-apply(waterholedists$dataDist, 1, min)

```


```{r}
quilt.plot(analysisdat$x.pos, analysisdat$y.pos, analysisdat$distwater_km, nrow=170, ncol=77, asp=1)
points(analysisdat$x.pos[analysisdat$response==1], analysisdat$y.pos[analysisdat$response==1], pch=20, col='lightblue')
```

### distance to nearest road

```{r}
require(rgeos)
spts<- SpatialPoints(cbind(analysisdat$x.pos, analysisdat$y.pos)*1000)
analysisdat$dist2road<-apply(gDistance(spts, roadsUTM, byid=TRUE), 2, min)/1000

```

```{r}
quilt.plot(analysisdat$x.pos, analysisdat$y.pos, analysisdat$dist2road, nrow=170, ncol=77, asp=1)
points(analysisdat$x.pos[analysisdat$response==1], analysisdat$y.pos[analysisdat$response==1], pch=20, col='purple')
```


### rainfall


```{r}
rainfall2<-read.csv('../data/Fieldrainfall1983to2015.csv')[1:156,]
```

Find the mean annual rainfall at each of 158 sites from 1999 to 2015 (no rainfall data available for 2016 or 2017). 

```{r}
rainfall2$meanrain<-apply(rainfall2[,23:38], 1, mean, na.rm=TRUE)
```

Transpose the lats and longs to UTMs.
```{r}
sputm <- SpatialPoints(cbind(rainfall2$E..X., rainfall2$S..Y.), proj4string=CRS("+proj=longlat +datum=WGS84"))  
  spgeo <- spTransform(sputm, CRS("+proj=utm +zone=33 +datum=WGS84") )
  rainfall2$x.pos<- spgeo@coords[,1]/1000
  rainfall2$y.pos<- spgeo@coords[,2]/1000
```

```{r}
quilt.plot(rainfall2$x.pos , rainfall2$y.pos , rainfall2$meanrain)
```



```{r}
require(mgcv)
fit<-gam(meanrain ~ s(x.pos, y.pos,fx = TRUE, k=150), data=rainfall2)
```

```{r}
preds<-predict(object = fit, 
               newdata=data.frame(x.pos=analysisdat$x.pos, y.pos=analysisdat$y.pos))
analysisdat$meanrain<-preds
```

```{r}
par(mfrow=c(2,2))
quilt.plot(rainfall2$x.pos , rainfall2$y.pos , rainfall2$meanrain, asp=1)
quilt.plot(rainfall2$x.pos , rainfall2$y.pos , fitted(fit), asp=1)
quilt.plot(analysisdat$x.pos , analysisdat$y.pos , preds, nrow=170, ncol=77, asp=1)
quilt.plot(rainfall2$x.pos , rainfall2$y.pos , rainfall2$meanrain-fitted(fit), asp=1)
```


```{r}
rainplot<- ggplot() + geom_tile(data=filter(analysisdat, response==0), aes(x=x.pos, y=y.pos, fill=meanrain), alpha=1, height = 2, width=2) +
  theme_bw() +
  labs(x='Easting (Km)', y='Northing (Km)') +
  scale_fill_gradient(low='lightblue', high='darkblue', name='Annual\nRainfall (mm)')+
  geom_polygon(data=data.frame(largepan), aes(x=x, y=y), fill='lightyellow')+
  geom_path(data=fences_fortify, aes(x=long/1000, y=lat/1000, group=group), colour='black', size=0.5)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ coord_equal()
```

```{r}
waterplot<- ggplot() + geom_tile(data=filter(analysisdat, response==0), aes(x=x.pos, y=y.pos, fill=distwater_km), alpha=1, height = 2, width=2) +
  theme_bw() +
  labs(x='Easting (Km)', y='Northing (Km)') +
  scale_fill_gradient(low='lightblue', high='darkblue', name='Distance to \nWater (Km)')+
  geom_polygon(data=data.frame(largepan), aes(x=x, y=y), fill='lightyellow')+
  geom_path(data=fences_fortify, aes(x=long/1000, y=lat/1000, group=group), colour='black', size=0.5)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ coord_equal()
```

```{r}
roadplot<- ggplot() + geom_tile(data=filter(analysisdat, response==0), aes(x=x.pos, y=y.pos, fill=dist2road), alpha=1, height = 2, width=2) +
  theme_bw() +
  labs(x='Easting (Km)', y='Northing (Km)') +
  scale_fill_gradient(low='lightblue', high='darkblue', name='Distance to \nRoad (Km)')+
  geom_polygon(data=data.frame(largepan), aes(x=x, y=y), fill='lightyellow')+
  geom_path(data=fences_fortify, aes(x=long/1000, y=lat/1000, group=group), colour='black', size=0.5)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ coord_equal()
```


```{r}
require(gridExtra)
png('../results/Mike_covardata.png', height = 1200, width=800)
grid.arrange(waterplot, roadplot, rainplot, nrow=3)
dev.off()
```



# 1D Analysis

Point process model:

```{r}
mutate(analysisdat, 
       nearwater = case_when(distwater_km<3 ~ 1, 
                             distwater_km >=3 ~ 0)) %>% 
  group_by(nearwater) %>% 
  summarise(n=n(), 
            pcount = sum(response), 
            meanresp = mean(response))
```

```{r}
analysisdat <- mutate(analysisdat, 
                      nearwater = case_when(distwater_km<3 ~ 1, 
                                            distwater_km >=3 ~ 0))
```


```{r}
analysisdat$y <- analysisdat$response/analysisdat$pp.wts
initialModel<- glm(response/pp.wts ~ 1 + nearwater, family='poisson', data=analysisdat, weights=pp.wts)
```



Distance to water removed owing to estimation issues.

```{r }
varlist<-c('dist2road', 'meanrain')
salsa1dlist<-list(fitnessMeasure='BIC', 
                  startKnots_1d=c(1,1), 
                  minKnots_1d=c(1,1), 
                  maxKnots_1d=c(3,3), 
                  degree=c(2,2), 
                  gaps=c(0,0),
                  modelType='pointProcess')
```

```{r 1dmodel, cache=TRUE}
salsa1doutput<-runSALSA1D(initialModel, 
                          salsa1dlist, 
                          varlist,
                          datain = analysisdat, 
                          suppress.printout = TRUE, 
                          removal = FALSE)
```

```{r}
ll<-sum(analysisdat$pp.wts * (((analysisdat$response/analysisdat$pp.wts) * log(fitted(salsa1doutput$bestModel))) - fitted(salsa1doutput$bestModel)))

ll

(-2*ll) + (log(nrow(analysisdat)) * length(coef(salsa1doutput$bestModel)))

```


```{r}
summary(salsa1doutput$bestModel)
```

```{r}
runPartialPlots(salsa1doutput$bestModel, analysisdat, factorlist.in = 'nearwater', varlist.in=c("dist2road", "meanrain"), showKnots=TRUE)
```

```{r}
meantable<-group_by(analysisdat, response) %>% 
  summarise(m.distwater_km=mean(distwater_km), m.dist2road=mean(dist2road), m.meanrain=mean(meanrain))

predict1dmeans<-data.frame(distwater_km=meantable[2,2], dist2road=meantable[2,3], meanrain=meantable[2,4], nearwater=0)

names(predict1dmeans)=c('distwater_km', 'dist2road', 'meanrain', 'nearwater')

modelin<-salsa1doutput$bestModel
B=500
for(i in 1:3){
  variable<-names(predict1dmeans)[i]
  datarange<-range(analysisdat[,variable])
  varseq<-seq(datarange[1], datarange[2], length=1000)
  eval(parse(text=paste('grid<-data.frame(predict1dmeans[,-',i,'],',variable,'=varseq)', sep='')))
  
  preds<-predict(object=modelin, newdata=grid, type='response')
  samplecoeff<- rmvnorm(B,coefficients(modelin),summary(modelin)$cov.scaled, method='svd')
  bootpreds<-matrix(NA, nrow=nrow(grid), ncol=B)
  for(b in 1:B){
    bootpreds[,b]<-predict.gamMRSea(newdata=grid, object=modelin, type='response', coeff=samplecoeff[b,])
  }
  cis<-makeBootCIs(bootpreds)
  plotdata=data.frame(preds, lower=cis[,1], upper=cis[,2], variable=varseq)
  eval(parse(text=paste("p", i, "<-ggplot() + geom_line(data=plotdata, aes(x=variable, y=preds)) + geom_ribbon(data=plotdata, aes(x=variable, ymin=lower, ymax=upper), alpha=1/5, fill='red')+ xlab(names(predict1dmeans)[i]) + ylab('Intensity') + theme_bw() + geom_rug(data=analysisdat[analysisdat$response==0,], aes(" , names(predict1dmeans)[i], "), sides='b') + geom_rug(data=analysisdat[analysisdat$response==1,], aes(",names(predict1dmeans)[i], "), sides = 't')", sep="")))
}

# factorvariable
i=4
variable<-names(predict1dmeans)[i]
varseq=c(0,1)
eval(parse(text=paste('grid<-data.frame(predict1dmeans[,-',i,'],',variable,'=varseq)', sep='')))

preds<-predict(object=modelin, newdata=grid, type='response')
samplecoeff<- rmvnorm(B,coefficients(modelin),summary(modelin)$cov.scaled, method='svd')
bootpreds<-matrix(NA, nrow=nrow(grid), ncol=B)
for(b in 1:B){
  bootpreds[,b]<-predict.gamMRSea(newdata=grid, object=modelin, type='response', coeff=samplecoeff[b,])
}
cis<-makeBootCIs(bootpreds)
plotdata=data.frame(preds, lower=cis[,1], upper=cis[,2], variable=varseq)

p4<-ggplot() + 
  geom_point(data=plotdata, aes(x=as.factor(variable), y=preds)) +
  geom_segment(data=plotdata, aes(x=as.factor(variable), y=lower, yend=upper, xend=as.factor(variable)), colour='red') + 
  xlab(names(predict1dmeans)[i]) + ylab('Intensity') + theme_bw()
 

```


```{r}
#p1
p2
p3
p4
```



```{r}
library(gridExtra)
png('../results/mike_analysis1D_partials.png', res=300, height=1700, width=1000)
grid.arrange(p2, p3, p4)
dev.off()
```

```{r}
require(latex2exp)
png('../results/mike_analysis1D_partials_rain.png', width=1000, res=300, height=600)
p3 + xlab("Mean Annual Rainfall (mm)")
dev.off()
png('../results/mike_analysis1D_partials_roads.png', width=1000, res=300, height=600)
p2 + xlab("Distance to Roads (Km)")
dev.off()
png('../results/mike_analysis1D_partials_water.png', width=1000, res=300, height=600)
p4 + scale_x_discrete(name ="Distance to Waterholes", 
                    limits=c("1","0"),
                    labels=c("<3km", "3km +"))
dev.off()
```

```{r}
analysisdat$preds1D<-fitted(salsa1doutput$bestModel)

```

```{r}
png('../results/mikeanalysis1D_risk_roads.png', height=900, width=2000, res=300)
ggplot() + 
  geom_tile(data=filter(analysisdat, response==0), aes(x=x.pos, y=y.pos, fill=preds1D), height=2, width=2) +
  #scale_fill_distiller(palette = "Spectral",name="Intensity", limits=c(0, 0.67)) +
  scale_fill_gradient(low='lightgrey', high='darkred', name='Intensity', limits=c(0, 0.35)) +
  coord_equal() + 
  theme_bw() +
  geom_point(data=filter(analysisdat, response==1), aes(x=x.pos, y=y.pos), shape=1, alpha=1/5)+
  geom_polygon(data=data.frame(largepan), aes(x=x, y=y), fill='lightblue')+
  geom_path(data=roads_fortify, aes(x=long/1000, y=lat/1000, group=group), colour='black', size=0.3, alpha=0.2)+
   geom_point(data=waterholelocs/1000, aes(coords.x1, coords.x2), colour = 'blue',shape=4, alpha=1/2) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + xlab('Easting (km)') + ylab("Northing (km)")
dev.off()
```

```{r}
png('../results/mikeanalysis1D_risk_roads_nopoints.png', height=900, width=2000, res=300)
ggplot() + 
  geom_tile(data=filter(analysisdat, response==0), aes(x=x.pos, y=y.pos, fill=preds1D), height=2, width=2) +
  #scale_fill_distiller(palette = "Spectral",name="Intensity", limits=c(0, 0.67)) +
  scale_fill_gradient(low='lightgrey', high='darkred', name='Intensity', limits=c(0, 0.35)) +
  coord_equal() + 
  theme_bw() +
#  geom_point(data=filter(analysisdat, response==1), aes(x=x.pos, y=y.pos), shape=1, alpha=1/5)+
  geom_polygon(data=data.frame(largepan), aes(x=x, y=y), fill='lightblue')+
  geom_path(data=roads_fortify, aes(x=long/1000, y=lat/1000, group=group), colour='black', size=0.3, alpha=0.2)+
   geom_point(data=waterholelocs/1000, aes(coords.x1, coords.x2), colour = 'blue',shape=4, alpha=1/2) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + xlab('Easting (km)') + ylab("Northing (km)")
dev.off()
```




```{r}
require(car)
anovatab<-Anova(salsa1doutput$bestModel)
anovatab$`LR Chisq`
anovatab$Df
anovatab$`Pr(>Chisq)`
```

```{r}
anova(salsa1doutput$bestModel)
```


# 2D Analysis

```{r }
salsa2dlist<-list(fitnessMeasure = 'BIC',
                  knotgrid = kg,
                  startKnots=60,
                  minKnots=2,
                  maxKnots=70,
                  cv.opts=list(K=5, cv.gamMRSea.seed=1),
                  modelType='pointProcess')
```

```{r 2dmodel, cache=TRUE}
salsa2dOutput<-runSALSA2D(salsa1doutput$bestModel, 
                          salsa2dlist, 
                          d2k=distMats$dataDist, 
                          k2k=distMats$knotDist, 
                          splineParams=NULL,
                          suppress.printout = FALSE, 
                          chooserad = FALSE, 
                          basis = 'exponential')
```

```{r}
summary(salsa2dOutput$bestModel)
```

```{r}
quilt.plot(analysisdat$x.pos[analysisdat$response==0],
           analysisdat$y.pos[analysisdat$response==0], 
           fitted(salsa2dOutput$bestModel)[analysisdat$response==0], 
           asp=1, nrow=170, ncol=77)
#points(analysisdat[analysisdat$response==1, c("x.pos", "y.pos")], col='lightblue')

```


# Outputs:


```{r}
analysisdat$preds2D<-fitted(salsa2dOutput$bestModel)  ```

```{r}
png('../results/mikeanalysis_risk_roads.png', height=900, width=2000, res=300)
ggplot() + 
  geom_tile(data=filter(analysisdat, response==0), aes(x=x.pos, y=y.pos, fill=preds2D), height=2, width=2) +
  #scale_fill_distiller(palette = "Spectral",name="Intensity", limits=c(0, 0.67)) +
  scale_fill_gradient(low='lightgrey', high='darkred', name='Intensity', limits=c(0, 0.68)) +
  coord_equal() + 
  theme_bw() +
  geom_point(data=filter(analysisdat, response==1), aes(x=x.pos, y=y.pos), shape=1, alpha=1/5)+
  geom_polygon(data=data.frame(largepan), aes(x=x, y=y), fill='lightblue')+
  geom_path(data=roads_fortify, aes(x=long/1000, y=lat/1000, group=group), colour='black', size=0.3, alpha=0.2)+
   geom_point(data=waterholelocs/1000, aes(coords.x1, coords.x2), colour = 'blue',shape=4, alpha=1/2) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + xlab('Easting (km)') + ylab("Northing (km)")
dev.off()
```


```{r}
png('../results/mikeanalysis_risk_roads_nopoints.png', height=900, width=2000, res=300)
ggplot() + 
  geom_tile(data=filter(analysisdat, response==0), aes(x=x.pos, y=y.pos, fill=preds2D), height=2, width=2) +
  #scale_fill_distiller(palette = "Spectral",name="Intensity", limits=c(0, 0.67)) +
  scale_fill_gradient(low='lightgrey', high='darkred', name='Intensity', limits=c(0, 0.68)) +
  coord_equal() + 
  theme_bw() +
  #geom_point(data=filter(analysisdat, response==1), aes(x=x.pos, y=y.pos), shape=1, alpha=1/5)+
  geom_polygon(data=data.frame(largepan), aes(x=x, y=y), fill='lightblue')+
  geom_path(data=roads_fortify, aes(x=long/1000, y=lat/1000, group=group), colour='black', size=0.3, alpha=0.2)+
   geom_point(data=waterholelocs/1000, aes(coords.x1, coords.x2), colour = 'blue',shape=4, alpha=1/2) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + xlab('Easting (km)') + ylab("Northing (km)")
dev.off()
```

```{r}
png('../results/mikeanalysis_1d2d_difference.png', height=900, width=2000, res=300)
ggplot() + 
  geom_tile(data=filter(analysisdat, response==0), aes(x=x.pos, y=y.pos, fill=preds2D - preds1D), height=2, width=2) +
  #scale_fill_distiller(palette = "Spectral",name="Intensity", limits=c(0, 0.67)) +
  scale_fill_gradient2(low = 'darkblue', mid='white', high='darkred') +
  coord_equal() + 
  theme_bw() +
  #geom_point(data=filter(analysisdat, response==1), aes(x=x.pos, y=y.pos), shape=1, alpha=1/5)+
  geom_polygon(data=data.frame(largepan), aes(x=x, y=y), fill='lightblue')+
  geom_path(data=roads_fortify, aes(x=long/1000, y=lat/1000, group=group), colour='black', size=0.3, alpha=0.2)+
   geom_point(data=waterholelocs/1000, aes(coords.x1, coords.x2), colour = 'blue',shape=4, alpha=1/2) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + xlab('Easting (km)') + ylab("Northing (km)")
dev.off()
```

```{r}
png('../results/mikeanalysis_risk_roads_zoom2D.png', height=900, width=1300, res=300)
z2<-ggplot() + 
  geom_tile(data=filter(analysisdat, response==0), aes(x=x.pos, y=y.pos, fill=preds2D), height=2, width=2) +
  #scale_fill_distiller(palette = "Spectral",name="Intensity", limits=c(0, 0.67)) +
  scale_fill_gradient(low='lightgrey', high='darkred', name='Intensity', limits=c(0, 0.68)) + 
  theme_bw() +
  geom_point(data=filter(analysisdat, response==1), aes(x=x.pos, y=y.pos), shape=1, alpha=1/5)+
  geom_polygon(data=data.frame(largepan), aes(x=x, y=y), fill='lightblue')+
  geom_path(data=roads_fortify, aes(x=long/1000, y=lat/1000, group=group), colour='black', size=0.3, alpha=0.2)+
   geom_point(data=waterholelocs/1000, aes(coords.x1, coords.x2), colour = 'blue',shape=4, alpha=1/2) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + xlab('Easting (km)') + ylab("Northing (km)") +
    scale_y_continuous(limits=c(-2100, -2030)) + 
    scale_x_continuous(limits=c(660, 740))+
  coord_equal()
z2
dev.off()
```

```{r}
png('../results/mikeanalysis_risk_roads_zoom1D.png', height=900, width=1300, res=300)
z1 <- ggplot() + 
  geom_tile(data=filter(analysisdat, response==0), aes(x=x.pos, y=y.pos, fill=preds1D), height=2, width=2) +
  #scale_fill_distiller(palette = "Spectral",name="Intensity", limits=c(0, 0.67)) +
  scale_fill_gradient(low='lightgrey', high='darkred', name='Intensity', limits=c(0, 0.35)) + 
  theme_bw() +
  geom_point(data=filter(analysisdat, response==1), aes(x=x.pos, y=y.pos), shape=1, alpha=1/5)+
  geom_polygon(data=data.frame(largepan), aes(x=x, y=y), fill='lightblue')+
  geom_path(data=roads_fortify, aes(x=long/1000, y=lat/1000, group=group), colour='black', size=0.3, alpha=0.2)+
   geom_point(data=waterholelocs/1000, aes(coords.x1, coords.x2), colour = 'blue',shape=4, alpha=1/2) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + xlab('Easting (km)') + ylab("Northing (km)") +
    scale_y_continuous(limits=c(-2100, -2030)) + 
    scale_x_continuous(limits=c(660, 740))+
  coord_equal()
z1
dev.off()
```

```{r}
png('../results/mikeanalysis_risk_roads_zoom1d2d.png', height=800, width=1900, res=300)
grid.arrange(z1, z2, ncol=2)
dev.off()
```
```{r}
library(viridis)
plotknots<-kg[salsa2dOutput$bestModel$splineParams[[1]]$knotPos,]
plotknots$coefsign<-as.factor(ifelse(coef(salsa2dOutput$bestModel)[-c(1:8)]<0, 0, 1))
plotknots$radii<-salsa2dOutput$bestModel$splineParams[[1]]$radii[salsa2dOutput$bestModel$splineParams[[1]]$radiusIndices]/100

modknots<-ggplot() +
  geom_point(data=plotknots,
             aes(x=x.pos, y=y.pos,colour=coefsign, size=radii), alpha=1/2) +
  theme_bw() + coord_equal() +
  labs(x='Easting (Km)', y='Northing (Km)') +
  geom_point(data=filter(analysisdat, response==1), aes(x=x.pos, y=y.pos), alpha=1/5, size=0.5) +
  geom_point(data=waterholelocs/1000, aes(coords.x1, coords.x2), colour = 'blue',shape=4, alpha=1/2) +
  geom_polygon(data=data.frame(largepan), aes(x=x, y=y), fill='lightblue')+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  geom_polygon(data=fence, aes(x=x.pos, y=y.pos), fill=NA, colour='black') +
   geom_path(data=roads_fortify, aes(x=long/1000, y=lat/1000, group=group), colour='black', size=0.3, alpha=0.2)+
  scale_size(guide=FALSE) +
  scale_color_viridis(discrete=TRUE) +
  guides(colour="none") 
  
png('../results/mikeanalysis_salsaknots.png', height=900, width=1500, res=300)
modknots
dev.off()
```


```{r}
riskdat<-analysisdat %>% filter(response==0) %>%
  mutate(preds2D_risk = as.factor(ifelse(preds2D>quantile(riskdat$preds2D, probs=0.95), 1, 0)))

png('../results/mikeanalysis_risk_roads_risk.png', height=900, width=2000, res=300)
z1 <- ggplot() + 
  geom_tile(data=riskdat, aes(x=x.pos, y=y.pos, fill=preds2D_risk), alpha=1/3, height=2, width=2) +
  #scale_fill_distiller(palette = "Spectral",name="Intensity", limits=c(0, 0.67)) +
 scale_fill_viridis_d(direction = -1, name='Risk Areas') +
  theme_bw() +
  #geom_point(data=filter(analysisdat, response==1), aes(x=x.pos, y=y.pos), shape=1, alpha=1/5)+
  geom_polygon(data=data.frame(largepan), aes(x=x, y=y), fill='lightblue')+
  geom_path(data=roads_fortify, aes(x=long/1000, y=lat/1000, group=group), colour='black', size=0.3, alpha=0.2)+
   geom_point(data=waterholelocs/1000, aes(coords.x1, coords.x2), colour = 'blue',shape=4, alpha=1/2) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + xlab('Easting (km)') + ylab("Northing (km)") +
  coord_equal()
z1
dev.off()
```

```{r}
require(car)
anovatab<-Anova(salsa2dOutput$bestModel)
anovatab$`LR Chisq`
anovatab$Df
anovatab$`Pr(>Chisq)`
```


```{r}
 ll<-sum(analysisdat$pp.wts * (((analysisdat$response/analysisdat$pp.wts) * log(fitted(salsa2dOutput$bestModel))) - fitted(salsa2dOutput$bestModel)))

ll

(-2*ll) + (log(nrow(analysisdat)) * length(coef(salsa2dOutput$bestModel)))
```



